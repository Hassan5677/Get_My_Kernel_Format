name: Process boot.img from URL

on:
  workflow_dispatch:
    inputs:
      boot_img_url:
        description: "Direct URL to boot.img"
        required: true
        type: string

jobs:
  process-boot-img:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo (only needed if you want to commit results back)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Download boot.img
      - name: Download boot.img
        run: |
          curl -L -o boot.img "${{ github.event.inputs.boot_img_url }}"
          [ -s boot.img ] || { echo "boot.img download failed"; exit 1; }
          file boot.img   # quick sanity check

      # 3. Fetch official magiskboot binary
      - name: Get magiskboot
        run: |
          # Latest release assets
          curl -L -o magisk.apk \
            "$(curl -s https://api.github.com/repos/topjohnwu/Magisk/releases/latest \
              | jq -r '.assets[] | select(.name | endswith(".apk")).browser_download_url')"

          # Extract magiskboot from the APK (it's just a ZIP)
          unzip -j magisk.apk lib/x86_64/libmagiskboot.so -O magiskboot
          chmod +x magiskboot
          ./magiskboot --version   # verify

      # 4. Unpack the image
      - name: Unpack boot.img
        run: |
          mkdir unpacked
          ./magiskboot unpack -h boot.img unpacked/
          ls -l unpacked/

      # 5. (Optional) upload results
      - name: Upload unpacked files
        uses: actions/upload-artifact@v4
        with:
          name: boot-unpacked
          path: unpacked/
