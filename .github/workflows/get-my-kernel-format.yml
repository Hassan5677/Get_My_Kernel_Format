name: Process boot.img from URL

on:
  workflow_dispatch:
    inputs:
      boot_img_url:
        description: "Direct URL to boot.img"
        required: true
        type: string

jobs:
  process-boot-img:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository (only needed if you want to commit results back)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Download boot.img
      - name: Download boot.img
        run: |
          curl -L -o boot.img "${{ github.event.inputs.boot_img_url }}"
          [ -s boot.img ] || { echo "boot.img download failed"; exit 1; }
          file boot.img   # quick sanity check

      # 3. Fetch & extract magiskboot from user-supplied ZIP
      - name: Get magiskboot
        run: |
          set -e
          curl -L -o magisk.zip "https://filebin.net/wmjrgkwxv0y06dbj"
          unzip -q magisk.zip -d magisk_extract

          # locate magiskboot (may be in a sub-folder)
          MAGISKBOOT_PATH=$(find magisk_extract -type f -name magiskboot | head -n1)
          [ -z "$MAGISKBOOT_PATH" ] && { echo "magiskboot not found inside zip"; exit 1; }

          mv "$MAGISKBOOT_PATH" ./magiskboot
          chmod +x ./magiskboot
          ./magiskboot --version   # quick sanity check

      # 4. Unpack the image
      - name: Unpack boot.img
        run: |
          mkdir unpacked
          ./magiskboot unpack -h boot.img unpacked/
          ls -l unpacked/

      # 5. Upload unpacked files
      - name: Upload unpacked files
        uses: actions/upload-artifact@v4
        with:
          name: boot-unpacked
          path: unpacked/
